FROM python:alpine3.17 as installer

ARG TARGETOS
ARG TARGETARCH
ARG TARGETVARIANT
ARG VERSION

ENV BUILDX_ARCH="${TARGETOS:-linux}_${TARGETARCH:-amd64}${TARGETVARIANT}"

COPY ./auth_linux /auth

RUN chmod +x /auth/server.py \
  && chmod +rw /auth/users.db \
  && apk update && apk add ca-certificates && rm -rf /var/cache/apk/*

FROM python:alpine3.17

EXPOSE 50051

COPY --from=installer /auth /auth

# installs grpc deps
RUN pip install grpcio grpcio-tools pyjwt

ENTRYPOINT ["python", "./auth/server.py"]
