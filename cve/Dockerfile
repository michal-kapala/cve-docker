FROM node:current-alpine3.17 as installer

ARG TARGETOS
ARG TARGETARCH
ARG TARGETVARIANT
ARG VERSION

ENV BUILDX_ARCH="${TARGETOS:-linux}_${TARGETARCH:-amd64}${TARGETVARIANT}"

COPY ./cve_linux /cve

RUN chmod +x /cve/build/server.js \
  && apk update && apk add ca-certificates && rm -rf /var/cache/apk/*

FROM node:current-alpine3.17

EXPOSE 50052

COPY --from=installer /cve /cve

# installs node modules
RUN cd cve && npm install

ENTRYPOINT cd cve && npm run start
